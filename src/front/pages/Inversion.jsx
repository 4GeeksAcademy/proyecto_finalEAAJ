import React, { useEffect, useState, useRef } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { Accordion, Card, Form, Table, Row, Col, Alert, Badge } from "react-bootstrap";
import CryptoWidget from "../CryptoWidget";
import {
  ResponsiveContainer,
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  CartesianGrid,
} from "recharts";


export const Inversion = () => {
  const location = useLocation();
  const navigate = useNavigate();


  // Estados de inversi√≥n
  const [monthlyInvestment, setMonthlyInvestment] = useState(50);
  const [years, setYears] = useState(10);
  const [rate, setRate] = useState(6);
  const [results, setResults] = useState([]);
  const [totals, setTotals] = useState({ invested: 0, final: 0, interest: 0 });
  const [token, setToken] = useState(null); // Inicialmente null hasta verificar
  const [loading, setLoading] = useState(true); // Estado de carga

  // Funci√≥n de validaci√≥n
  const validateToken = (token) => {
    return token &&
      typeof token === "string" &&
      token !== "null" &&
      token !== "undefined" &&
      token.trim().length > 10;
  };

  // Efecto para verificar el token al montar el componente
  useEffect(() => {
    const checkAuth = () => {
      const savedToken = localStorage.getItem("token");
      setToken(validateToken(savedToken) ? savedToken : null);
      setLoading(false);
    };

    checkAuth();

    const handleStorageChange = () => {
      checkAuth();
    };

    window.addEventListener('storage', handleStorageChange);
    return () => window.removeEventListener('storage', handleStorageChange);
  }, []);

  // Efecto para scroll
  useEffect(() => {
    if (!loading) { // Solo hacer scroll cuando haya terminado de cargar
      const anchor = location.hash.replace("#", "");
      if (anchor) {
        const element = document.getElementById(anchor);
        if (element) element.scrollIntoView({ behavior: "smooth" });
      }
    }
  }, [location, loading]);

  // Sincronizaci√≥n con localStorage
  useEffect(() => {
    const handleStorageChange = () => {
      const savedToken = localStorage.getItem("token");
      setToken(validateToken(savedToken) ? savedToken : null);
    };

    // Escuchar cambios en otras pesta√±as
    window.addEventListener('storage', handleStorageChange);

    // Verificaci√≥n inicial
    handleStorageChange();

    return () => window.removeEventListener('storage', handleStorageChange);
  }, []);

  // C√°lculo de crecimiento 
  useEffect(() => {
    calculateGrowth();
  }, [monthlyInvestment, years, rate]);

  const calculateGrowth = () => {
    const r = rate / 100 / 12;
    const n = years * 12;
    let total = 0;
    let yearlyData = [];

    for (let i = 1; i <= n; i++) {
      total = total * (1 + r) + parseFloat(monthlyInvestment);
      if (i % 12 === 0) {
        yearlyData.push({
          year: i / 12,
          total: total.toFixed(2),
        });
      }
    }

    const totalInvested = monthlyInvestment * n;
    const finalTotal = total;
    const interestEarned = total - totalInvested;

    setResults(yearlyData);
    setTotals({
      invested: totalInvested.toFixed(2),
      final: finalTotal.toFixed(2),
      interest: interestEarned.toFixed(2),
    });
  };

  return (
    <div className="container mt-5">
        <Card className="p-4 mb-5 bg-white">
          <h3 className="mb-3">üß≠ Bienvenido al Espacio de Inversi√≥n para J√≥venes</h3>
          <p className="fs-5">
            Aqu√≠ aprender√°s de forma sencilla c√≥mo empezar a invertir, con consejos pr√°cticos,
            simuladores personalizados y explicaciones claras sobre criptomonedas, acciones
            y fondos indexados. Ideal si quieres <strong>ahorrar, invertir y ganar autonom√≠a financiera</strong>,
            aunque partas desde cero.
          </p>
          <p className="fs-5 mb-0">
            <strong>¬øQu√© encontrar√°s aqu√≠?</strong>
            <ul className="fs-5">
              <li>üí° Consejos clave para empezar con buen pie</li>
              <li>üßÆ Un simulador interactivo de inversi√≥n a largo plazo</li>
              <li>‚Çø Informaci√≥n √∫til sobre criptomonedas, acciones y fondos indexados</li>
              <li>üîê Acceso a herramientas exclusivas si est√°s registrado</li>
            </ul>
          </p>
        </Card>
        {/* Parte visible para todo el mundo */}
        <Card className="p-4 mb-5">
          <h4 className="mb-3">üìä Criptomonedas: ¬øOportunidad o riesgo?</h4>
          <Alert variant="warning" className="mb-3">
            <strong>Atenci√≥n:</strong> Las criptos pueden subir o bajar un 50% en un d√≠a. Solo para perfiles con alta tolerancia al riesgo.
          </Alert>
          <CryptoWidget />
        </Card>

        <Card className="p-4 bg-light mb-5">
          <h4>üí° 5 Reglas de oro para j√≥venes inversores</h4>
          <ul className="fs-5">
            <li><strong>Empieza YA</strong>: A los 20 a√±os, 50‚Ç¨/mes pueden ser 200.000‚Ç¨ a los 65.</li>
            <li><strong>Automatiza</strong>: Programa transferencias mensuales y olv√≠date.</li>
            <li><strong>Diversifica</strong>: No pongas todo en cripto (mezcla con fondos indexados).</li>
            <li><strong>Ignora el "FOMO"</strong>: Comprar porque "todo el mundo lo hace" suele acabar mal.</li>
            <li><strong>La educaci√≥n supera a la suerte</strong>: Gana quien aprende, no quien apuesta.</li>
          </ul>
        </Card>

        {/* Parte privada: solo visible si hay token */}
        {token ? (
          <Card className="p-4 bg-white mb-5">
            <h4 className="mb-4">üßÆ Simulador: "Si hubiera empezado a los 20 a√±os..."</h4>

            <Alert variant="success" className="mb-4">
              <div className="d-flex">
                <div className="me-3">‚ú®</div>
                <div>
                  <strong>El inter√©s compuesto es magia:</strong> Si inviertes <strong>{monthlyInvestment}‚Ç¨/mes</strong> durante <strong>{years} a√±os</strong> al <strong>{rate}% anual</strong>, tus <span className="text-primary">{totals.invested}‚Ç¨</span> invertidos se convertir√≠an en <span className="text-success">{totals.final}‚Ç¨</span> (¬°<span className="text-danger">+{totals.interest}‚Ç¨</span> de intereses!).
                </div>
              </div>
            </Alert>

            <Form className="mb-4">
              <Row>
                <Col md={4}>
                  <Form.Group>
                    <Form.Label>Inversi√≥n mensual (‚Ç¨)</Form.Label>
                    <Form.Control
                      type="number"
                      value={monthlyInvestment}
                      onChange={(e) => setMonthlyInvestment(e.target.value)}
                      min={1}
                    />
                  </Form.Group>
                </Col>
                <Col md={4}>
                  <Form.Group>
                    <Form.Label>A√±os</Form.Label>
                    <Form.Control
                      type="number"
                      value={years}
                      onChange={(e) => setYears(e.target.value)}
                      min={1}
                    />
                  </Form.Group>
                </Col>
                <Col md={4}>
                  <Form.Group>
                    <Form.Label>Rentabilidad anual (%)</Form.Label>
                    <Form.Control
                      type="number"
                      value={rate}
                      onChange={(e) => setRate(e.target.value)}
                      min={0}
                    />
                  </Form.Group>
                </Col>
              </Row>
            </Form>

            <div style={{ width: "100%", height: 300 }} className="mb-4">
              <h5 className="text-center">Tu progreso a√±o a a√±o</h5>
              <ResponsiveContainer>
                <LineChart data={results}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="year" />
                  <YAxis />
                  <Tooltip
                    formatter={(value) => `${parseFloat(value).toFixed(2)} ‚Ç¨`}
                    labelFormatter={(value) => `A√±o ${value}`}
                  />
                  <Line
                    type="monotone"
                    dataKey="total"
                    stroke="#4e73df"
                    strokeWidth={3}
                    dot={{ r: 4 }}
                    activeDot={{ r: 6 }}
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>

            <Table striped bordered hover className="mt-3">
              <thead className="table-dark">
                <tr>
                  <th>A√±o</th>
                  <th>Total acumulado</th>
                  <th>Intereses ese a√±o</th>
                </tr>
              </thead>
              <tbody>
                {results.map((r, index) => {
                  const previousTotal = index > 0 ? parseFloat(results[index - 1].total) : 0;
                  const yearlyInterest = (parseFloat(r.total) - previousTotal - monthlyInvestment * 12).toFixed(2);

                  return (
                    <tr key={r.year}>
                      <td>{r.year}</td>
                      <td>{r.total} ‚Ç¨</td>
                      <td className={yearlyInterest > 0 ? "text-success" : "text-danger"}>
                        {yearlyInterest} ‚Ç¨
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </Table>

            <Alert variant="info" className="mt-4">
              <h5>üìå Caso pr√°ctico: Mar√≠a vs. Pedro</h5>
              <p>
                <strong>Mar√≠a (25 a√±os):</strong> Invierte 100‚Ç¨/mes al 7% hasta los 65 a√±os ‚Üí <strong>264.000‚Ç¨</strong>.<br />
                <strong>Pedro (35 a√±os):</strong> Empieza igual pero 10 a√±os despu√©s ‚Üí solo <strong>122.000‚Ç¨</strong>.<br />
                <span className="text-danger">Moraleja: 10 a√±os de diferencia = ¬°+142.000‚Ç¨!</span>
              </p>
            </Alert>
          </Card>
        ) : (
          <Alert variant="info" className="mt-4">
            <strong>üîí Accede o reg√≠strate</strong> para usar el simulador personalizado de inversi√≥n.
          </Alert>
        )}

        {/* Secci√≥n Bitcoin - Versi√≥n Mejorada */}
        <div id="bitcoin" className="mb-5">
          <h3 className="d-flex align-items-center">
            <span className="me-2">‚Çø</span> Bitcoin: El activo m√°s vol√°til del mundo
          </h3>

          <Alert variant="warning" className="border-start border-5 border-warning">
            <div className="d-flex">
              <div className="me-3">üé¢</div>
              <div>
                <strong>¬øSab√≠as que...?</strong>
                <ul className="mb-0 mt-2">
                  <li>En <span className="text-danger">2011</span> Bitcoin perdi√≥ el <strong>93%</strong> de su valor en 5 meses</li>
                  <li>En <span className="text-success">2017</span> subi√≥ un <strong>1,900%</strong> en un a√±o</li>
                  <li>En <span className="text-danger">2022</span> empresas como Tesla perdieron <strong>1.38B ‚Ç¨</strong> en BTC</li>
                </ul>
                <div className="mt-2 fw-bold">Regla de oro: <span className="text-info">M√°ximo 5% de tu portfolio</span></div>
              </div>
            </div>
          </Alert>

          <div className="mt-3">
            <p>La primera criptomoneda (2009) funciona como:</p>
            <ul>
              <li>üõ°Ô∏è <strong>Antiinflaci√≥n:</strong> Solo existir√°n 21 millones (17m ya circulan)</li>
              <li>üåé <strong>Sin fronteras:</strong> Transfiere valor a cualquier pa√≠s en minutos</li>
              <li>‚ö° <strong>Sin intermediarios:</strong> Bancos y gobiernos no pueden congelar tu dinero</li>
            </ul>
          </div>

          <Accordion>
            <Accordion.Item eventKey="0">
              <Accordion.Header className="fw-bold">üì≤ Gu√≠a pr√°ctica: Primeros pasos</Accordion.Header>
              <Accordion.Body>
                <div className="row">
                  <div className="col-md-6">
                    <strong>üìà D√≥nde comprar:</strong>
                    <div className="mt-2">
                      <Badge bg="success" className="me-2 mb-2">Binance</Badge>
                      <Badge bg="primary" className="me-2 mb-2">Coinbase</Badge>
                      <Badge bg="dark" className="me-2 mb-2">Kraken</Badge>
                    </div>

                    <div className="mt-3">
                      <strong>üîê Wallets seguras:</strong>
                      <ul className="mt-2">
                        <li>Ledger Nano X (‚Ç¨149)</li>
                        <li>Trezor Model T (‚Ç¨189)</li>
                        <li>Exodus (gratis)</li>
                      </ul>
                    </div>
                  </div>

                  <div className="col-md-6">
                    <strong>üí£ Riesgos reales:</strong>
                    <ul>
                      <li>Exchange hackeado (FTX perdi√≥ 7.36B ‚Ç¨ en 2022)</li>
                      <li>Olvidar contrase√±as (se pierden 9.2B ‚Ç¨ en BTC)</li>
                      <li>Estafas (30% de proyectos crypto son fraudes)</li>
                    </ul>
                  </div>
                </div>
              </Accordion.Body>
            </Accordion.Item>
          </Accordion>
        </div>

        {/* Secci√≥n Acciones - Versi√≥n Mejorada */}
        <div id="acciones" className="mb-5">
          <h3>üìà Acciones: Convi√©rtete en due√±o parcial de empresas</h3>

          <Alert variant="primary" className="border-start border-5 border-primary">
            <div className="d-flex">
              <div className="me-3">üìä</div>
              <div>
                <strong>El poder del largo plazo:</strong>
                <div className="mt-2">
                  <span className="d-block">9,200‚Ç¨ invertidos en...</span>
                  <div className="d-flex flex-wrap mt-2">
                    <Badge bg="success" className="me-2 mb-2">Amazon (2001): 2,208,000‚Ç¨</Badge>
                    <Badge bg="danger" className="me-2 mb-2">Enron (2001): 0‚Ç¨</Badge>
                    <Badge bg="success" className="me-2 mb-2">Apple (1980): 6,440,000‚Ç¨ </Badge>
                    <Badge bg="warning" className="me-2 mb-2">GameStop (2014): 276‚Ç¨</Badge>
                  </div>
                </div>
                <div className="mt-2 fw-bold">Clave: <span className="text-success">Diversifica + Invierte en lo que entiendas</span></div>
              </div>
            </div>
          </Alert>

          <div className="mt-3">
            <p>Cuando compras acciones:</p>
            <ul>
              <li>üìå <strong>Eres copropietario:</strong> Participas en ganancias (dividendos)</li>
              <li>üìÖ <strong>El tiempo es tu aliado:</strong> Mercado sube un 70% de los a√±os</li>
              <li>üí° <strong>Informaci√≥n = Ventaja:</strong> Analiza balances y tendencias</li>
            </ul>
          </div>

          <Accordion>
            <Accordion.Item eventKey="1">
              <Accordion.Header className="fw-bold">üöÄ Estrategias para empezar</Accordion.Header>
              <Accordion.Body>
                <div className="row">
                  <div className="col-md-6">
                    <strong>üì± Apps recomendadas:</strong>
                    <ul className="mt-2">
                      <li><span className="text-success">eToro:</span> Copia a inversores expertos</li>
                      <li><span className="text-primary">Degiro:</span> Comisiones desde ‚Ç¨0.50</li>
                      <li><span className="text-info">Interactive Brokers:</span> Profesional (m√°s complejo)</li>
                    </ul>

                    <div className="mt-3">
                      <strong>üìö Libros esenciales:</strong>
                      <ul>
                        <li>"El Inversor Inteligente" - Benjamin Graham</li>
                        <li>"Un paseo aleatorio por Wall Street" - Burton Malkiel</li>
                      </ul>
                    </div>
                  </div>

                  <div className="col-md-6">
                    <strong>‚ö†Ô∏è Errores comunes:</strong>
                    <ul>
                      <li>Comprar por hype (memestocks)</li>
                      <li>Vender por p√°nico (ca√≠das temporales)</li>
                      <li>Invertir con dinero prestado</li>
                      <li>No reinvertir dividendos</li>
                    </ul>
                  </div>
                </div>
              </Accordion.Body>
            </Accordion.Item>
          </Accordion>
        </div>

        {/* Secci√≥n Fondos Indexados - Versi√≥n Mejorada */}
        <div id="fondos" className="mb-5">
          <h3>üåç Fondos Indexados: La autopista hacia la libertad financiera</h3>

          <Alert variant="success" className="border-start border-5 border-success">
            <div className="d-flex">
              <div className="me-3">üëë</div>
              <div>
                <strong>Warren Buffett lo tiene claro:</strong>
                <div className="mt-2">
                  "Despu√©s de mi muerte, el 90% de mi fortuna ir√° a un <span className="text-success">fondo indexado del S&P 500</span>.
                  Es la mejor opci√≥n para la mayor√≠a de inversores."
                </div>
                <div className="mt-2">
                  <small>Buffett apost√≥ 1 mill√≥n y gan√≥: los fondos indexados lo hicieron mejor que los hedge funds en esos 10 a√±os</small>
                </div>
              </div>
            </div>
          </Alert>

          <div className="mt-3">
            <p>¬øPor qu√© son revolucionarios?</p>
            <ul>
              <li>ü§ñ <strong>Automatizaci√≥n:</strong> Inviertes en 500+ empresas sin esfuerzo</li>
              <li>üí∏ <strong>Bajas comisiones:</strong> 0.20% vs 2% de los bancos</li>
              <li>üìà <strong>Rentabilidad probada:</strong> +10% anual promedio (S&P 500)</li>
            </ul>
          </div>

          <Accordion>
            <Accordion.Item eventKey="2">
              <Accordion.Header className="fw-bold">üõå C√≥mo implementarlo en 3 pasos</Accordion.Header>
              <Accordion.Body>
                <div className="row">
                  <div className="col-md-6">
                    <strong>1Ô∏è‚É£ Elige tu fondo:</strong>
                    <ul className="mt-2">
                      <li><span className="text-success">Vanguard S&P 500</span> (IE00B3XXRP09)</li>
                      <li><span className="text-primary">iShares MSCI World</span> (IE00B4L5Y983)</li>
                      <li><span className="text-info">Amundi Prime Global</span> (LU2089238204)</li>
                    </ul>

                    <div className="mt-4">
                      <strong>2Ô∏è‚É£ Plataformas low-cost:</strong>
                      <ul>
                        <li>Indexa Capital (Espa√±a)</li>
                        <li>MyInvestor (Vanguard)</li>
                        <li>Boggleheads (comunidad)</li>
                      </ul>
                    </div>
                  </div>

                  <div className="col-md-6">
                    <strong>3Ô∏è‚É£ Estrategia infalible:</strong>
                    <ol>
                      <li>Destina un % fijo de tu sueldo (ej. 15%)</li>
                      <li>Automatiza las compras mensuales</li>
                      <li>Olv√≠date durante 20+ a√±os</li>
                      <li>Revisa solo 1 vez al a√±o</li>
                    </ol>

                    <div className="alert alert-info mt-3">
                      <strong>üí° Ejemplo real:</strong> 460‚Ç¨/mes durante 30 a√±os al 7% = <span className="text-success">563.040‚Ç¨</span>
                    </div>
                  </div>
                </div>
              </Accordion.Body>
            </Accordion.Item>
          </Accordion>
        </div>
        <Card className="p-5 mb-5" style={{ background: "linear-gradient(135deg, #f0f4ff, #e9f7ef)" }}>
          <h3 className="mb-3">üöÄ Da el primer paso hacia tu libertad financiera</h3>
          <p className="fs-5 text-muted">
            No hace falta ser un experto. Empieza con peque√±as cantidades, s√© constante y deja que el inter√©s compuesto haga su magia.
          </p>

          <ul className="fs-5 mb-4 text-muted">
            <li>ü™ô Aprende a invertir desde cero</li>
            <li>üìà Simula tu crecimiento a largo plazo</li>
            <li>üîç Explora opciones reales y seguras</li>
          </ul>

          {!token && (
            <div className="text-center">
              <button
                className="btn btn-primary btn-lg px-4 py-2 rounded-pill shadow-sm"
                onClick={() => navigate("/login")}
              >
                üîê Inicia sesi√≥n para usar el simulador
              </button>
            </div>
          )}
        </Card>
      </div>
      );
};


